trigger: none
pr: none


variables:
  environmentName: "provision-vm-example-${{ variables['Build.SourceVersion'] }}"


stages:
- stage: Provision
  condition: succeeded()
  jobs:
  - job:
    displayName: 'Provision VM in Environment'
    steps:
    - task: AzureCLI@2
      displayName: 'Provision and register Azure VM'
      inputs:
        azureSubscription: 'Azure Visual Studio Enterprise'
        scriptType: pscore
        scriptLocation: inlineScript
        inlineScript: |
          az group create --name $(environmentName) --location westeurope;

          az vm create `
            --name ProvisionedVM `
            --image Win2019Datacenter `
            --admin-password Password12345!`
            --resource-group $(environmentName);


- stage: Test
  dependsOn: Provision
  condition: succeeded()
  jobs:
  - deployment: TestCustomTask
    environment:
      name: '$(environmentName)'
      resourceType: VirtualMachine
    strategy:
      runOnce:
        deploy:
          steps:
          - task: InstallNetCoreRuntimeAndHosting@1
            displayName: 'Install .NET (Core) 6.0'
            inputs:
              version: '6.0'
              norestart: true